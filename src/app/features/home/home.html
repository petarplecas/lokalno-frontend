<section class="home">
  <!-- Search bar -->
  <div class="home__search">
    <svg class="home__search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
    </svg>
    <input
      type="search"
      class="home__search-input"
      placeholder="Pretra≈æi popuste..."
      [value]="searchQuery()"
      (input)="onSearchInput($event)"
      aria-label="Pretraga popusta"
    />
  </div>

  <!-- Category pills -->
  <div class="home__categories" role="tablist" aria-label="Kategorije">
    @for (pill of categoryPills; track pill.label; let i = $index) {
      <button
        class="home__pill"
        [class.home__pill--active]="activeCategory() === i"
        role="tab"
        [attr.aria-selected]="activeCategory() === i"
        (click)="onCategoryChange(i)"
      >
        {{ pill.label }}
      </button>
    }
  </div>

  <!-- Location bar -->
  <div class="home__location-bar">
    <button
      class="home__location-btn"
      [class.home__location-btn--active]="locationActive()"
      (click)="onToggleLocation()"
      [attr.aria-pressed]="locationActive()"
      aria-label="Koristi moju lokaciju"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" width="16" height="16">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
      </svg>
      @if (geo.loading()) {
        Uƒçitavanje...
      } @else if (locationActive()) {
        U blizini
      } @else {
        Moja lokacija
      }
    </button>

    @if (locationActive()) {
      <div class="home__radius">
        @for (option of radiusOptions; track option) {
          <button
            class="home__radius-chip"
            [class.home__radius-chip--active]="radiusKm() === option"
            (click)="onRadiusSelect(option)"
            [attr.aria-pressed]="radiusKm() === option"
          >{{ radiusLabel(option) }}</button>
        }
      </div>
    }

    @if (geo.error()) {
      <div class="home__location-error">
        @if (geo.error() === 'denied') {
          <p class="home__location-error-title">Lokacija je blokirana</p>
          <p class="home__location-error-steps">
            Da omoguƒáite lokaciju:
          </p>
          <ol class="home__location-error-list">
            <li>Kliknite na ikonu <strong>katanca</strong> (ili <strong>i</strong>) levo od adrese u pregledaƒçu</li>
            <li>Pronaƒëite <strong>Lokacija</strong> i postavite na <strong>Dozvoli</strong></li>
            <li>Osve≈æite stranicu</li>
          </ol>
        } @else {
          <p>{{ geo.error() }}</p>
        }
      </div>
    }
  </div>

  <!-- Filter bar -->
  <div class="home__filter-bar">
    <span class="home__count">{{ total() }} popusta</span>
    <select
      class="home__sort"
      [value]="activeSortBy()"
      (change)="onSortChange($event)"
      aria-label="Sortiraj po"
    >
      @for (opt of sortOptions; track opt.value) {
        <option [value]="opt.value">{{ opt.label }}</option>
      }
    </select>
  </div>

  <!-- Loading state -->
  @if (loading()) {
    <div class="home__loading">
      <app-spinner size="lg" />
    </div>
  }

  <!-- Error state -->
  @if (error()) {
    <app-empty-state
      title="Gre≈°ka pri uƒçitavanju"
      message="Nije moguƒáe uƒçitati popuste. Proverite internet konekciju."
      actionLabel="Poku≈°aj ponovo"
      (action)="onRetry()"
    />
  }

  <!-- Empty state -->
  @if (isEmpty()) {
    <app-empty-state
      icon="üîç"
      title="Nema pronaƒëenih popusta"
      [message]="searchQuery() ? 'Poku≈°ajte sa drugim pojmom pretrage' : 'Trenutno nema aktivnih popusta u ovoj kategoriji'"
    />
  }

  <!-- Discount grid -->
  @if (!loading() && discounts().length > 0) {
    <div class="home__grid">
      @for (discount of discounts(); track discount.id) {
        <app-discount-card
          [discount]="discount"
          (clicked)="onDiscountClick($event)"
        />
      }
    </div>

    <!-- Infinite scroll sentinel -->
    @if (hasMore()) {
      <div appInfiniteScroll (scrolled)="onLoadMore()" class="home__sentinel">
        @if (loadingMore()) {
          <app-spinner size="sm" />
        }
      </div>
    }
  }
</section>
